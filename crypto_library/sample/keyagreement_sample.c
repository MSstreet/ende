#include "test_code.h"
#include "edge_crypto.h"
int dh_sample();
int ecdh_sample();

int keyagreement_sample() {
    int ret = 0;

    ret = dh_sample();
    if (ret != 0) return ret;

    ret = ecdh_sample();
    if (ret != 0) return ret;

    return ret;
}

int dh_sample() {
    int ret = 0;

    EDGE_ASYM_KEY_PARAM key_param;
    uint8_t public_key1[2048] = { 0x00, };
    uint32_t public_key1length = 0;
    uint8_t private_key1[2048] = { 0x00, };
    uint32_t private_key1length = 0;
    uint8_t public_key2[2048] = { 0x00, };
    uint32_t public_key2length = 0;
    uint8_t private_key2[2048] = { 0x00, };
    uint32_t private_key2length = 0;
    uint8_t secret[2048] = { 0x00, };
    uint32_t secretlength = 0;

    memset(&key_param, 0, sizeof(EDGE_ASYM_KEY_PARAM));
    key_param.m_algorithm = EDGE_ASYM_ID_DH;
    key_param.dsa.m_pBitLength = 2048;
    key_param.dsa.m_qBitLength = 224;
    key_param.dsa.m_reqGenParam = 0;
    uint8_t p[256] = { 0x8C,0x45,0x4B,0xA6,0x5B,0x50,0xA1,0x05,0xB4,0x38,0x76,0xF2,0x12,0x3B,0x3D,0xA8,0x63,0x71,0x62,0xDF,0x3F,0x99,0xFB,0x5B,0x20,0xB2,0xE6,0x36,0x6B,0xC7,0x7A,0xDD,0x8D,0x05,0xD7,0x26,0xEF,0xED,0x58,0x83,0x47,0xA0,0x27,0x1A,0x43,0x60,0x59,0xFD,0xCD,0xEB,0x4D,0x2A,0x9F,0xF7,0x96,0xB7,0xC6,0x06,0xB2,0x17,0x82,0x30,0xE5,0x92,0x0E,0x06,0x68,0x35,0x89,0x5D,0x17,0xBC,0xF2,0x8E,0x44,0x71,0x2D,0xC2,0xA9,0x69,0x54,0xEC,0xF4,0x6B,0x7F,0x9D,0x89,0x50,0x26,0x9E,0x24,0xAC,0x89,0xBC,0x02,0x00,0xE6,0xBA,0xF9,0x2E,0x9B,0x60,0x8A,0x15,0x9A,0xDA,0x29,0x54,0xCC,0xA6,0xF9,0x34,0xB7,0xCD,0xFB,0x1B,0x07,0xCE,0x7F,0x48,0x82,0x3B,0x4E,0x7B,0xC8,0x21,0xBA,0x5E,0xF0,0xA5,0x67,0x1F,0x0E,0x91,0x0C,0xBC,0x49,0x25,0xD2,0xAA,0x53,0x16,0xD7,0xEF,0x42,0xC2,0xDC,0x49,0xA4,0x59,0x9B,0x33,0xE0,0x33,0xC7,0x95,0xDA,0x70,0xD4,0x8B,0x8E,0x8F,0x8E,0x7C,0xC6,0xF6,0xA2,0xE6,0xA9,0xB9,0xD9,0xAA,0x63,0x5C,0x5E,0xA0,0x3B,0x80,0x55,0x75,0x40,0x84,0xAD,0xAF,0xF3,0x45,0xF0,0xB5,0x4C,0x20,0xC5,0xD8,0x38,0x27,0x67,0x7E,0x62,0x2D,0x1A,0xD8,0xD3,0xD7,0x67,0x4F,0xF5,0x63,0x1B,0xE7,0x52,0x79,0x1F,0x22,0x94,0x4D,0x1A,0xE9,0xA5,0xDF,0x12,0xA8,0x7A,0xE0,0x05,0xBA,0x05,0x5F,0xCE,0xD4,0x31,0x6B,0xEC,0x0B,0xE7,0x3E,0xA0,0x58,0xDB,0x8D,0x56,0xE2,0x0A,0x41,0x85,0x4A,0xC2,0xCC,0x7A,0xA9,0x3A,0x43,0x0D,0xF2,0x74,0x79,0x64,0xB7, };
    uint32_t plen = 256;
    uint8_t q[28] = { 0x89,0xDB,0xAC,0xE3,0x90,0x33,0xE6,0xEA,0x6F,0x51,0x6C,0x4A,0x85,0x4A,0xA2,0x28,0x2A,0x50,0xA9,0x55,0x0F,0xD9,0xC2,0x4C,0x16,0x70,0x31,0xAF, };
    uint32_t qlen = 28;
    uint8_t g[256] = { 0x6D,0x51,0xF7,0x45,0x49,0xD4,0x80,0x0F,0x2A,0x46,0x42,0x41,0xD1,0xE3,0x25,0x8B,0xF8,0x9F,0xC1,0xF7,0xAB,0xB8,0x6D,0xE4,0xF6,0x35,0xFF,0x58,0xA0,0x21,0x67,0x3B,0x4A,0xBD,0x5A,0x7F,0x67,0x41,0x6B,0x27,0xC3,0x41,0xA0,0x2A,0x8F,0x12,0x2E,0xE4,0xA9,0x4D,0xD8,0x67,0x38,0xCF,0x97,0xD2,0xC7,0x34,0x7B,0x69,0x7C,0xF1,0x58,0x65,0xDD,0x9E,0xBD,0x6F,0x9E,0xC9,0xF5,0x55,0x23,0x3C,0xF0,0xF7,0xF4,0xFC,0xF9,0x54,0xCE,0xB7,0x81,0xCC,0xB7,0x9D,0xE1,0x43,0x98,0xD3,0xE5,0xD9,0x33,0xC5,0x26,0xE1,0x56,0x88,0x2A,0x05,0x93,0x15,0x09,0x85,0xC9,0x91,0x06,0xF2,0xDC,0x81,0xFD,0x6D,0x02,0x09,0x28,0xA3,0xDD,0xB6,0x67,0xEF,0xE6,0x78,0x64,0x85,0xED,0x4F,0x8F,0x87,0x75,0x9F,0xAA,0x81,0x1C,0x52,0x63,0x76,0x91,0x23,0x6E,0x08,0x47,0x42,0xE7,0x1D,0xDE,0xAD,0x8B,0x6E,0x8C,0x45,0x30,0x38,0x46,0x2C,0xF2,0xBA,0x52,0x3A,0x36,0x99,0xF8,0xC0,0x9C,0x74,0x6C,0xFF,0xB1,0x9C,0xE1,0xCB,0x47,0x3E,0xFE,0x4F,0x2D,0xCF,0x14,0x57,0xB9,0xA4,0xF1,0xA0,0xCB,0xAF,0x10,0xC2,0x28,0x3C,0x57,0x78,0x21,0x5A,0xF2,0xA1,0x12,0x9C,0x5D,0x7E,0x0B,0x7E,0x9D,0x6B,0x46,0xFA,0x8E,0x9A,0x68,0x82,0xBA,0x1C,0x59,0xE2,0x08,0x42,0x06,0x5C,0x85,0x5C,0x51,0xB6,0x4B,0x17,0xC8,0x46,0x62,0xA0,0xBB,0xBF,0x96,0x57,0xE5,0x0B,0xF9,0x6D,0xF8,0x84,0x71,0xB6,0x2A,0x88,0xF8,0x23,0xE8,0x6C,0x68,0x30,0x8E,0xC5,0x2C,0xC7,0xA0,0x17,0x8E,0xB8,0x40,0x42, };
    uint32_t glen = 256;
    memcpy(key_param.dsa.m_param.m_p, p, plen); key_param.dsa.m_param.m_pLen = plen;
    memcpy(key_param.dsa.m_param.m_q, q, qlen); key_param.dsa.m_param.m_qLen = qlen;
    memcpy(key_param.dsa.m_param.m_g, g, glen); key_param.dsa.m_param.m_gLen = glen;

    printf("\n##======================      dh_sample() start     ======================##\n");
    do {
        printf("\n *----------------------   edge_asym_gen_keypair()  ------------------------\n");
        ret = edge_asym_gen_keypair(public_key1, &public_key1length, private_key1, &private_key1length, &key_param);
        if (ret != 0) break;

        hexdump("private_key1", private_key1, private_key1length);
        hexdump("public_key1", public_key1, public_key1length);

    	key_param.dsa.m_reqGenParam = 0;
        printf("\n *----------------------   edge_asym_gen_keypair()  ------------------------\n");
        ret = edge_asym_gen_keypair(public_key2, &public_key2length, private_key2, &private_key2length, &key_param);
        if (ret != 0) break;

        hexdump("private_key2", private_key2, private_key2length);
        hexdump("public_key2", public_key2, public_key2length);

        printf("\n *----------------------     edge_keyagreement()    ------------------------\n");
        ret = edge_keyagreement(EDGE_KEYAGREEMENT_ID_DH, &key_param.dsa.m_param, public_key1, public_key1length, private_key2, private_key2length, secret, &secretlength);
        if (ret != 0) break;
        hexdump("secret", secret, secretlength);
    } while (0);
    printf("\n##======================       dh_sample() end      ======================##\n");

    return ret;
}

int ecdh_sample() {
    int					ret = 0;
    uint8_t				public_key1[2048] = { 0x00, }; uint32_t public_key1length = 0;
    uint8_t				private_key1[2048] = { 0x00, }; uint32_t private_key1length = 0;
    uint8_t				public_key2[2048] = { 0x00, }; uint32_t public_key2length = 0;
    uint8_t				private_key2[2048] = { 0x00, }; uint32_t private_key2length = 0;
    uint8_t				secret[2048] = { 0x00, }; uint32_t secretlength = 0;
    EDGE_ASYM_KEY_PARAM	key_param;

    memset(&key_param, 0, sizeof(EDGE_ASYM_KEY_PARAM));
    key_param.m_algorithm = EDGE_ASYM_ID_ECDH + EDGE_ASYM_ID_ECC_P256;

    printf("\n##======================     ecdh_sample() start    ======================##\n");
    do {
        printf("\n *----------------------   edge_asym_gen_keypair()  ------------------------\n");
        ret = edge_asym_gen_keypair(public_key1, &public_key1length, private_key1, &private_key1length, &key_param);

        hexdump("private_key1", private_key1, private_key1length);
        hexdump("public_key1", public_key1, public_key1length);

        printf("\n *----------------------   edge_asym_gen_keypair()  ------------------------\n");
        ret = edge_asym_gen_keypair(public_key2, &public_key2length, private_key2, &private_key2length, &key_param);

        hexdump("private_key2", private_key2, private_key2length);
        hexdump("public_key2", public_key2, public_key2length);

        printf("\n *----------------------     edge_keyagreement()    ------------------------\n");
        ret = edge_keyagreement(EDGE_KEYAGREEMENT_ID_ECDH + EDGE_ASYM_ID_ECC_P256, NULL,
								public_key1, public_key1length, private_key2, private_key2length, secret, &secretlength);
        hexdump("secret", secret, secretlength);
    } while (0);
    printf("\n##======================      ecdh_sample() end     ======================##\n");

	edge_crypto_zeroize (private_key1, private_key1length);
	edge_crypto_zeroize (private_key2, private_key2length);
	edge_crypto_zeroize (secret, secretlength);

    return ret;
}
